<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0 user-scalable=no">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <meta name="description" contents="">

    <title>Select outfit (v1.1)</title>

    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootbox-dialoges.css">
    <link rel="stylesheet" href="/css/alerts.css">
    <link rel="stylesheet" href="/css/anywhere3d.css">
    <link rel="stylesheet" href="/css/index.css">

    <script> debugMode = true; </script>
    <script src="/outfits/sw.js"></script>

    <script src="/js/Objectid.js"></script>
    <script src="/js/zangodb.min.js"></script>
    <script src="/socketcluster.js"></script>
    <script src="/sc-codec-min-bin.js"></script>

    <script src="/js/store2.js"></script>
    <script src="/js/hammer.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery-ui.js"></script>
    <script src="/js/validator.js"></script>
    <script src="/js/system.min.js"></script>
    <script src="/js/signals.min.js"></script>
    <script src="/js/DeviceDetector.js"></script>

</head>

<body>

<style>

    body {
        overflow:auto;
        background-color:#fff;
    }

    .snapshot-item {
        width:85px;
        height:85px;
        margin:4px;
        border:thin solid #ccc;
        background-size: contain;
        background-position:50% 50%;
        background-repeat:no-repeat;
    }

    .tab-pane {
        width:100%;
        min-height:250px;;
    }

    #outfit-title {
        outline:0;
        color:#999;
        border: none;
        background: none;
        box-shadow: none;
        font-size: 3rem;
        font-weight: bold;
        font-family: sans-serif;
        text-overflow:ellipsis;
        cursor:context-menu;

    }

    #outfit-value {
        outline:0;
        color:#fff;
        border:none;
        margin:auto;
        height:5rem;
        max-width:50%;
        font-size:3rem;
        font-weight:bold;
        font-family:sans-serif;
        background-color:#6495ed;
        cursor:context-menu;
    }

    #outfit-preview-pane {
        width:49%;
        height:600px;
        min-width:49%;
        max-width:100%;
        text-align:center;
        display:inline-block;
    /*  border:thin solid #ccc; */
    }

    #preview-container {
        max-width:100%;
        text-align:center;
        overflow-y:hidden;
    }

    img#outfit-preview {
        width:auto;
        margin:auto;
        min-height:350px;
        max-height:450px;
    }

    #outfit-select-pane {
        width:49%;
    /*  height:600px; */
        float:right;
        min-width:49%;
        max-width:100%;
        display:inline-block;
        overflow:auto;
    /*  border:thin solid #ccc; */
    }

    #outfit-select {
        width:100%;
        margin:auto;
        height:600px;
        min-height:400px;
        max-height:600px;
        font-family:sans-serif;
    }

    @media all and ( max-width: 640px ) {

        #outfit-preview-pane {
            width:100%;
        }

        #outfit-select-pane {
            width:100%;
            float:unset;
            height:400px;
            min-height:400px;
            max-height:unset;
            overflow:unset;

        }

        #outfit-purcashe {
            height:100%;
        }

        #outfit-value {
            max-width:100%;
        }

    }

    #select-button {
        color:#fff;
        min-width:50%;
        font-size:2rem;
        padding:6px 14px;
        border:1px solid #ddd;
        border-radius:20px;
        background-color:#42bcf9;
    }

    #description-tab {
        padding:30px;
    }

    #outfit-preview,
    #outfit-snapshots {
        transition:transform 250ms ease-out;
    }

    #live-test-button {
        min-width:50%;
        font-size:2rem;
        font-weight:bold;
        border-radius:20px;
        background-color:#f4b400;
    }

</style>

<section class="mbr-section" id="details-section">

    <div class="container well" style="background-color:#fff;">

        <h1 style="text-align:center;">Select your outfit</h1>
    <!--
        <div id="outfit-title-pane" style="margin-bottom:20px;">
            <input type="text" id="outfit-title" class="form-control text-center x-large outfit-title-field" placeholder="outfit title" readOnly>
        </div>
    -->
        <div id="outfit-preview-pane">

            <div id="preview-container" style="max-width:100%;min-height:466px;text-align:center;">
                <!-- src="/img/no-image-avaliable-200x200.png" -->
                <img id="outfit-preview" src="/outfits/img/young-joyful-teens-430x480.jpg"> 
            </div>

            <script>

                (function (){
                    $("img#outfit-preview").on("load", function(){
                        $(this).fadeIn(500);
                        if ( this.src.startsWith("blob:") ) {
                            window.URL.revokeObjectURL(this.src); // important!
                        }
                    });
                })();

                (function (){
                    if ( !window.Hammer ) return;
                    if ( window.isMobile ) return;
                    const parent = $("#preview-container").get(0);
                    const element = $("img#outfit-preview").get(0);
                    parent.style["scroll-behavior"] = "smooth";
                    var manager = new Hammer(element);
                    manager.on("swipe", function(e) {
                        if ( e.offsetDirection === 4 || e.offsetDirection === 2 ) {
                            parent.scrollLeft -= e.deltaX;
                        }
                    });
                })();

            </script>

            <div id="outfit-title-pane">
                <input type="text" id="outfit-title" class="form-control text-center x-large outfit-title-field" placeholder="outfit title" readOnly>
            </div>

            <div id="outfit-snapshots-pane" style="max-width:100%;display:inline-block;">
                <div id="snapshots-container" style="margin:20px 0px;overflow-y:hidden;max-width:100%;text-align:center;">
                    <div id="outfit-snapshots" class="product-snapshots" style="display:inline-block;width:max-content;text-align:center;">
                    <!-- 
                        <li class="btn btn-default btn-white-outline snapshot-item outfit-snapshot-item"></li>
                        <li class="btn btn-default btn-white-outline snapshot-item outfit-snapshot-item"></li>
                        <li class="btn btn-default btn-white-outline snapshot-item outfit-snapshot-item"></li>
                        <li class="btn btn-default btn-white-outline snapshot-item outfit-snapshot-item"></li>
                        <li class="btn btn-default btn-white-outline snapshot-item outfit-snapshot-item"></li>
                        <li class="btn btn-default btn-white-outline snapshot-item outfit-snapshot-item"></li>
                    -->
                    </div>
                </div>
            </div>
        </div>

        <div id="outfit-select-pane">
            <div id="outfit-select">

                <hr/>
                <div style="text-align:center;">
                    <div id="select-button" class="btn btn-info btn-white-outline">Select</div>
                </div>
                <hr/>

                <h4 style="font-weight:bold;">Description:</h4>
                <p id="outfit-description" style="padding:0px 20px;overflow:hidden;text-overflow:ellipsis;">
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Etiam quis mi eu elit tempor facilisis id et neque. Nulla sit amet sem sapien. Vestibulum imperdiet porta ante ac ornare. Nulla et lorem eu nibh adipiscing ultricies nec at lacus. Cras laoreet ultricies sem, at blandit mi eleifend aliquam. Nunc enim ipsum, vehicula non pretium varius, cursus ac tortor. Vivamus fringilla congue laoreet. Quisque ultrices sodales orci, quis rhoncus justo auctor in. Phasellus dui eros, bibendum eu feugiat ornare, faucibus eu mi. Nunc aliquet tempus sem, id aliquam diam varius ac. Maecenas nisl nunc, molestie vitae eleifend vel, iaculis sed magna. Aenean tempus lacus vitae orci posuere porttitor eget non felis. Donec lectus elit, aliquam nec eleifend sit amet, vestibulum sed nunc.
                </p>

            </div>
        </div>

    </div>

    <div id="outfit-tabs-pane">

        <div style="width:100%;margin-bottom:20px;">
            <ul class="nav nav-tabs nav-pills" style="width:100%;overflow-x:auto;overflow-y:hidden;">

                <li class="active" role="presentation"><a href="#description-tab" data-toggle="pill" class="pills right-pill right-pill-description">Description</a></li>
                <li class role="presentation"><a href="#outfits-tab" data-toggle="pill" class="pills right-pill right-pill-outfits">Outfit</a></li>
                <li class role="presentation"><a href="#texture-tab" data-toggle="pill" class="pills right-pill right-pill-outfits">Texture</a></li>
                <li class role="presentation"><a href="#product-tab" data-toggle="pill" class="pills right-pill right-pill-product">Product</a></li>
                <li class role="presentation"><a href="#reviews-tab" data-toggle="pill" class="pills right-pill right-pill-info">Reviews</a></li>
                <li class role="presentation"><a href="#informs-tab" data-toggle="pill" class="pills right-pill right-pill-info">Info</a></li>

            </ul>
        </div>

        <div class="tab-content">

            <div id="description-tab" class="product-description component-pane tab-pane fade in active"></div>
            <div id="outfits-tab" class="component-pane tab-pane fade"></div>
            <div id="texture-tab" class="component-pane tab-pane fade"></div>
            <div id="product-tab" class="component-pane tab-pane fade"></div>
            <div id="reviews-tab" class="component-pane tab-pane fade"></div>
            <div id="informs-tab" class="component-pane tab-pane fade"></div>

        </div>

    </div>

<!--
    <div id="additional-tab-pane">

        <div style="width:100%;margin-bottom:20px;">
            <ul class="nav nav-tabs nav-pills" style="width:100%;overflow:hidden;">
                <li class="active" role="presentation" style="width:100%"><a href="#additional-options-tab" data-toggle="pill" class="pills right-pill right-pill-options">Additional options</a></li>
            </ul>
        </div>

        <div class="tab-content">
            <div id="additional-options-tab" class="component-pane tab-pane fade in active"></div>
        </div>

    </div>
-->

</section>

<script>

//  Socketcluster.

    var socket = socketCluster.create({
        hostname: "anywhere3d.com",
        codecEngine: scCodecMinBin,
    });

    socket.on("connect", function(status){
        debugMode && console.log({"status": status});
    });

    socket.on("error", function (err) {
        console.error( err.stack );
    });

    socket.on("authStateChange", function( state ){
        debugMode && console.log({"authStateChange": state});
    });

    socket.on("subscribe", function( name, object ){
        debugMode && console.log(`subscribed successfully to "${name}" channel:`, object);
    });

</script>


<script>

(function(){

    const snapshotsContainer = document.getElementById("snapshots-container");

    function SwipeMouseScrolling(element){

        if ( !window.Hammer ) return;
        if ( window.isMobile ) return;

    //  For horizontal scrolling 
    //  overflow-y must be "hidden".

        element.style["overflow-y"] = "hidden";

    //  Smoother scroll.

        element.style["scroll-behavior"] = "smooth";

    //  Create a manager to manager the element.

        var manager = new Hammer(element);

    //  Subscribe to a desired event.

        manager.on("swipe", function(e) {

            if ( e.offsetDirection === 4 || e.offsetDirection === 2 ) {

                element.scrollLeft -= e.deltaX;

            }

        });

    }

    SwipeMouseScrolling( snapshotsContainer );

})();

</script>


<script>

Promise.all([

    caches.open("thumbnails").then(function(cache){ return cache; }),
    caches.open("snapshots" ).then(function(cache){ return cache; }),

]).then(function([thumbCache, snapsCache]){

    var db = new zango.Db( "PUBLIC", {
        "avatars": true,
    });

    var selectedAvatar; // important!
    var collection = db.collection("avatars");

    const outfitTitle = document.getElementById("outfit-title");
    const selectButton = document.getElementById("select-button");
    const outfitPreview = document.getElementById("outfit-preview");
    const outfitSnapshots = document.getElementById("outfit-snapshots");
    const outfitDescription = document.getElementById("outfit-description");

    var Signal = signals.Signal;
    var outfitSelectButtonClicked = new Signal();

    $(selectButton).on("click", function(){
        if (!selectedAvatar) return;
        clearTimeout(this.interval);
        this.interval = setTimeout(function(){
            debugMode && console.log(selectedAvatar);
            outfitSelectButtonClicked.dispatch(selectedAvatar.uuid);
        }, 200);
    });

    outfitSelectButtonClicked.add(function(uuid){

        socket.emit("multiplex findOne", {
        //  collection:"multiplex",
            selectors:{product_UUID:uuid},
        }, function(err, data){
            if (!data) throw `Avatar ${uuid} not found!`;

            debugMode && console.log(
                JSON.parse(JSON.stringify(data))
            );

            store( "Avatar", data );
            window.location.pathname = "/demo/";

        });

    });


    collection.find().toArray(function(err){
        if (err) throw err;
    }).then(function(docs){

    //  Remove elements.
        $(outfitSnapshots).children().remove(); // important!

        docs.forEach(function(data){

            var snapsURL = `//i.imgur.com/${data.preview[0]}.jpg`;
            var thumbURL = `//i.imgur.com/${data.preview[0]}s.jpg`;

            var element = document.createElement("li");
            element.id = data.uuid; // important!
            element.title = data.name[0]; // fields are arrays.
            element.classList.add(
                "btn", "btn-default", "btn-white-outline", 
                "snapshot-item", "outfit-snapshot-item"
            );

        //  element.style.cssText = `background-image:url(${thumbObjURL})`;

            thumbCache.match(thumbURL).then(function(response){

                if (!response) 
                    throw `Thumbnail ${thumbURL} not found!`;

                return response.blob();

            }).catch(function(err){
                console.error(err);

                return thumbCache.add(thumbURL).then(function(){
                    return thumbCache.match(thumbURL).then(function(response){
                        return response.blob();
                    });
                });

            }).then(function(blob){

                var objectURL = URL.createObjectURL(blob);
                element.style.cssText = `background-image:url(${objectURL})`;
                return objectURL;

            }).then(function(objectURL){
                URL.revokeObjectURL(objectURL);
            });

            $(element).on("click", function(){
                if ( $(this).hasClass("selected") ) return;

                clearTimeout(this.interval);
                this.interval = setTimeout(function(){

                //  encapsulated data.
                //  debugMode && console.log(data);

                //  Set this as selected.
                    $(".outfit-snapshot-item").removeClass("selected");
                    $(element).addClass("selected");     // important!

                //  Set title.
                    outfitTitle.value = ""; // reset.
                    outfitTitle.value = data.name[0];

                //  Set preview.
                    $(outfitPreview).fadeOut(250);
                    snapsCache.match(snapsURL)
                        .then(function(response){
                        return response.blob();
                    }).then(function(blob){
                        setTimeout(function(){
                            outfitPreview.src = URL.createObjectURL(blob);
                        }, 200);
                    });

                //  Set description.
                    outfitDescription.innerText = ""; // reset.
                    if (data.description) {
                        outfitDescription.innerText = data.description;
                    }

                    selectedAvatar = data; // TODO: encapsulate!
                    debugMode && console.log(selectedAvatar);

                }, 200);

            });

        //  debugMode && console.dir(element);
            $(outfitSnapshots).append(element);

        });

    }).catch(function(err){
        console.error(err);
    });

});

</script>

<script>
/*
    new Promise(function(resolve, reject){
        socket.emit("mongo find", {
            collection:"onsite-avatars",
            selectors: {"kind":"outfits"},
        }, function(err, data){
            if (err) console.error(err);
            resolve(data);
        });

    }).then(function(docs){
        debugMode && console.log(docs);

        //  Remove elements.
        $(outfitSnapshots).children().remove(); // debugging!

        docs.forEach(function(data){

            // TODO: CACHE PREVIEW/THUMBNAIL.

            var thumbnail = `//i.imgur.com/${data.preview}s.jpg`;
            var previewURL = `//i.imgur.com/${data.preview}.jpg`;

            //  Encapsulated data. All these data are not neccesary as
            //  we will ecapsulate the data inside the "click" handler.

            var element = document.createElement("li");
            element.id = data.uuid; // important!
            element.title = data.name; //  element.thumbnail = thumbnail;
            element.style.cssText = `background-image:url(${thumbnail})`;
            element.classList.add("btn", "btn-default", "btn-white-outline", "snapshot-item", "outfit-snapshot-item");

            $(element).on("click", function(){
                if ( $(this).hasClass("selected") ) return;

                clearTimeout(this.interval);
                this.interval = setTimeout(function(){

                    //  Reset.
                    outfitTitle.value = "";
                    outfitDescription.innerText = "";

                    //  encapsulated data.
                    //  debugMode && console.log(data);

                    //  Set this as selected.
                    $(".outfit-snapshot-item").removeClass("selected");
                    $(element).addClass("selected");     // important!

                    //  Title.
                    outfitTitle.value = data.name;

                    //  Preview.
                    $(outfitPreview).fadeOut(250);
                    setTimeout(function(){
                        outfitPreview.src = previewURL;
                    }, 200);

                    //  Description.
                    if (data.description) {
                        outfitDescription.innerText = data.description;
                    }

                    selectedOutfit = data;
                    //  debugMode && console.dir(element);
                    debugMode && console.log(selectedOutfit);

                }, 200);
            });

            //  debugMode && console.dir(element);
            $(outfitSnapshots).append(element);

        });

    }).catch(function(err){
        console.error(err);
    });
*/

/*
    return new Promise(function(resolve, reject){
        socket.emit("mongo findOne", {
            collection:data.collection,
            selectors:{uuid:data.item_UUID},
            options:{fields:{_id:0, uuid:0}},
        }, function(err, data){
            resolve(data);
            debugMode && console.log(data);
        });
    });
*/

</script>

</body>
</html>
